graph TB
    subgraph "Engine Crate (guisu-engine)"
        subgraph "State Management"
            SourceState["SourceState<br/>Repository Files<br/>+ Attributes"]
            TargetState["TargetState<br/>Processed Content<br/>+ Rendered Templates"]
            DestState["DestinationState<br/>Actual Files on Disk"]
            PersistentState["PersistentState<br/>redb Database<br/>+ Content Hashes"]
        end

        subgraph "Entry Types"
            SourceEntry["SourceEntry<br/>File/Dir/Symlink<br/>+ FileAttributes"]
            TargetEntry["TargetEntry<br/>File/Dir/Symlink/Remove<br/>+ Content/Mode"]
            DestEntry["DestEntry<br/>EntryKind + Metadata"]
        end

        subgraph "Processing Pipeline"
            ContentProcessor["ContentProcessor<br/>Generic<D, R>"]
            AttrParser["AttributeParser<br/>Filename â†’ Attributes"]
            Comparator["Comparator<br/>Three-Way Compare"]
        end

        subgraph "File Attributes"
            Attrs["FileAttributes<br/>bitflags<br/>DOT | PRIVATE | TEMPLATE<br/>ENCRYPTED | EXECUTABLE"]
        end

        SourceState -->|Contains| SourceEntry
        TargetState -->|Contains| TargetEntry
        DestState -->|Contains| DestEntry

        SourceEntry -->|Parse| AttrParser
        AttrParser -->|Produces| Attrs

        SourceEntry -->|Process| ContentProcessor
        ContentProcessor -->|1. Decrypt (.age)| TargetEntry
        ContentProcessor -->|2. Render (.j2)| TargetEntry

        TargetEntry -->|Compare| Comparator
        DestEntry -->|Compare| Comparator
        PersistentState -->|Compare| Comparator

        Comparator -->|Determine| Status["FileStatus<br/>Synced/Modified/Added<br/>Removed/Conflict"]
    end

    style SourceState fill:#CDDC39,stroke:#9E9D24,stroke-width:2px,color:#000
    style TargetState fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff
    style DestState fill:#FFC107,stroke:#F57F17,stroke-width:2px,color:#000
    style PersistentState fill:#009688,stroke:#00695C,stroke-width:2px,color:#fff
    style ContentProcessor fill:#2196F3,stroke:#1565C0,stroke-width:2px,color:#fff
    style Comparator fill:#9C27B0,stroke:#6A1B9A,stroke-width:2px,color:#fff
    style Attrs fill:#F44336,stroke:#C62828,stroke-width:2px,color:#fff
