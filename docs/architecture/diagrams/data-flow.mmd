graph TD
    Start([User: guisu apply])

    Start --> LoadConfig[Load Configuration<br/>.guisu.toml + variables]
    LoadConfig --> LoadIdentities[Load Age Identities<br/>For decryption]
    LoadIdentities --> CreateEngine[Create Template Engine<br/>minijinja + functions]
    CreateEngine --> BuildContext[Build Template Context<br/>os, arch, hostname, vars]

    BuildContext --> ReadSource[Read Source State<br/>Walk repository directory<br/>PARALLEL with rayon]

    ReadSource --> ParseAttrs[Parse Attributes<br/>.j2, .age extensions]
    ParseAttrs --> SourceEntries[SourceEntry objects<br/>File/Dir/Symlink + Attrs]

    SourceEntries --> BuildTarget[Build Target State<br/>PARALLEL processing]

    BuildTarget --> ProcessFiles{For each file}

    ProcessFiles -->|1| Decrypt[Decrypt if .age<br/>Age decryptor]
    Decrypt -->|2| RenderTemplate[Render if .j2<br/>Template engine]
    RenderTemplate -->|3| ApplyMode[Set permissions<br/>from Unix mode bits]
    ApplyMode --> TargetEntry[TargetEntry<br/>Processed content]

    TargetEntry --> ReadDest[Read Destination<br/>Actual files on disk]
    ReadDest --> ReadDB[(Read Database<br/>Last applied state)]

    ReadDB --> Compare[Three-Way Compare<br/>Target vs Dest vs DB]

    Compare --> CheckStatus{File Status?}

    CheckStatus -->|Synced| Skip[Skip<br/>No changes needed]
    CheckStatus -->|Added| Apply[Apply Changes]
    CheckStatus -->|Modified| CheckInteractive{Interactive mode?}
    CheckStatus -->|Conflict| CheckInteractive

    CheckInteractive -->|Yes| ShowTUI[Show TUI<br/>Diff viewer + prompt]
    ShowTUI --> UserDecision{User choice?}
    UserDecision -->|Overwrite| Apply
    UserDecision -->|Skip| Skip
    UserDecision -->|Quit| End([Cancelled])

    CheckInteractive -->|No| Apply

    Apply --> WriteFile[Write to destination<br/>Create/Update file]
    WriteFile --> SetPerms[Set permissions<br/>chmod/chown]
    SetPerms --> UpdateDB[Update Database<br/>Store content hash + mode]

    UpdateDB --> NextFile{More files?}
    Skip --> NextFile

    NextFile -->|Yes| ProcessFiles
    NextFile -->|No| ShowStats[Show Statistics<br/>Added/Modified/Skipped]

    ShowStats --> End([Complete])

    style Start fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff
    style End fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff
    style LoadConfig fill:#2196F3,stroke:#1565C0,stroke-width:2px,color:#fff
    style ReadSource fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff
    style BuildTarget fill:#9C27B0,stroke:#6A1B9A,stroke-width:2px,color:#fff
    style Decrypt fill:#F44336,stroke:#C62828,stroke-width:2px,color:#fff
    style RenderTemplate fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff
    style Compare fill:#795548,stroke:#4E342E,stroke-width:2px,color:#fff
    style ShowTUI fill:#00BCD4,stroke:#00838F,stroke-width:2px,color:#fff
    style WriteFile fill:#8BC34A,stroke:#558B2F,stroke-width:2px,color:#fff
    style UpdateDB fill:#009688,stroke:#00695C,stroke-width:2px,color:#fff
