stateDiagram-v2
    [*] --> SourceEntry: Read from repository

    SourceEntry --> ParseAttributes: Parse filename
    ParseAttributes --> FileAttributes: .j2, .age ext + Unix mode

    FileAttributes --> TargetEntry: Process content

    state TargetEntry {
        [*] --> ReadFile: Read source
        ReadFile --> Decrypt: If .age extension
        Decrypt --> RenderTemplate: If .j2 extension
        RenderTemplate --> ApplyMode: Set permissions
        ApplyMode --> [*]: Processed content
    }

    TargetEntry --> Compare: Compare states

    state Compare {
        Target: Target (desired)
        Dest: Destination (actual)
        DB: Database (last applied)

        [*] --> Target
        Target --> ThreeWay: Compare
        Dest --> ThreeWay
        DB --> ThreeWay
        ThreeWay --> FileStatus
    }

    Compare --> FileStatus

    state FileStatus <<choice>>
    FileStatus --> Synced: No changes
    FileStatus --> Added: New file
    FileStatus --> Modified: Dest changed
    FileStatus --> Conflict: Both changed

    Synced --> [*]: Skip
    Added --> ApplyChanges
    Modified --> CheckInteractive
    Conflict --> CheckInteractive

    state CheckInteractive <<choice>>
    CheckInteractive --> InteractiveTUI: If -i flag
    CheckInteractive --> ApplyChanges: Auto apply

    state InteractiveTUI {
        [*] --> ShowDiff: Display comparison
        ShowDiff --> UserPrompt: Get decision
        UserPrompt --> Overwrite: User choice
        UserPrompt --> Skip
        UserPrompt --> Quit
    }

    InteractiveTUI --> ApplyChanges: Overwrite
    InteractiveTUI --> [*]: Skip/Quit

    ApplyChanges --> WriteFile: Write to dest
    WriteFile --> UpdateDatabase: Store hash
    UpdateDatabase --> [*]: Complete

    note right of SourceEntry
        Files in repository with
        encoded attributes in filename
    end note

    note right of FileAttributes
        bitflags:
        DOT | PRIVATE | TEMPLATE
        ENCRYPTED | EXECUTABLE
    end note

    note right of Compare
        Three-way comparison
        detects all change scenarios
    end note

    note right of UpdateDatabase
        Persistent state tracking
        enables change detection
    end note
